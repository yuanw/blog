<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>My Hakyll Blog - 2019-11-30-haskell-nix</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
    </head>
    <body>
        <div id="header">
            <div id="logo">
                <a href="../">Yuan</a>
            </div>
            <div id="navigation">
                <a href="../">Home</a>
                <a href="../about.html">About</a>
                <a href="../contact.html">Contact</a>
                <a href="../archive.html">Archive</a>
            </div>
        </div>

        <div id="content">
            <h1>2019-11-30-haskell-nix</h1>

            <div class="info">
    Posted on November 30, 2019
    
</div>

<header>
<div class="logo">
<a href="../">Yuan Wang’s Blog</a>
</div>
<nav> <a href="../">Home</a> <a href="../about.html">About</a> <a href="../archive.html">Archive</a> </nav>
</header>
<div role="main">
<h1 id="setup-a-haskell-development-enivronment-using-nix-working-process">Setup a haskell development enivronment using nix (Working Process)</h1>
<article>
<section class="header">
Posted on November 30, 2019 by Yuan Wang
</section>
<section>
<h1 id="disclaimers">Disclaimers</h1>
<p>I am still learning nix and haskell in general, please take it with a grain of salt on everthing mentioned here.</p>
<h1 id="environments">Environments</h1>
<ul>
<li>OS: MacOS 10.14.16</li>
<li>Nix: 2.3.1</li>
<li>Editor: Spacemacs - 0.300.0@26.3</li>
<li>GHC : 8.6.5</li>
<li>Cabal: 2.4.1.0</li>
<li>“IDE”: haskell-ide-engine 0.13.0.0 x86_64 ghc-8.6.5</li>
</ul>
<p>GHC, Cabal, and haskell-ide-engine (hie) is managed via nix-shell.</p>
<h1 id="why-nix">Why Nix</h1>
<p>The last thing I want to do is to drag anyone into build tool war. If It Ain’t Broke, Don’t Nix it <a href="https://www.youtube.com/watch?v=G9yiJ7d5LeI" class="uri">https://www.youtube.com/watch?v=G9yiJ7d5LeI</a></p>
<h1 id="nix-basics">Nix Basics</h1>
<h2 id="install-nix">Install nix</h2>
<div id="cb1" class="sourceCode">
<div class="sourceCode" id="cb1"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1"></a><span class="ex">curl</span> https://nixos.org/nix/install <span class="kw">|</span> <span class="fu">sh</span></span></code></pre></div>
</div>
<h2 id="upgrade-nix"><a href="https://nixos.org/nix/manual/#ch-upgrading-nix">Upgrade nix</a></h2>
<div id="cb2" class="sourceCode">
<div class="sourceCode" id="cb2"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1"></a><span class="ex">nix-channel</span> --update<span class="kw">;</span> <span class="ex">nix-env</span> -iA nixpkgs</span></code></pre></div>
</div>
<h2 id="uninstall-nix">Uninstall nix</h2>
<pre class="shell"><code>rm -rf /nix</code></pre>
<pre class="shell"><code>nix-prefetch-git https://github.com/NixOS/nixpkgs.git 19.09 &gt; nixpkgs-19-09.json</code></pre>
<p><a href="https://github.com/data61/fp-course/blob/master/nix/nixpkgs.nix" class="uri">https://github.com/data61/fp-course/blob/master/nix/nixpkgs.nix</a></p>
<p>to find the current nixos versions <a href="https://github.com/NixOS/nixpkgs-channels/branches" class="uri">https://github.com/NixOS/nixpkgs-channels/branches</a></p>
<h1 id="setup-a-haskellnix-project-with-hie">Setup a haskell+nix project with hie</h1>
<h2 id="all-major-haskell-ide-like-efforts-i-am-aware-of">all major Haskell IDE-like efforts I am aware of</h2>
<ul>
<li><a href="https://github.com/haskell/haskell-ide-engine">haskell-ide-engine(hie)</a></li>
<li><a href="https://github.com/digital-asset/ghcide">ghcide</a></li>
<li><a href="https://github.com/jyp/dante">dante</a> (emacs plugin)</li>
<li><a href="https://github.com/ndmitchell/ghcid">ghcid</a></li>
<li><a href="https://github.com/leksah/leks">Leksah</a> (an IDE for haskell)</li>
</ul>
<p>Among them, I like hie the most. Currently, hie has something <a href="https://github.com/haskell/haskell-ide-engine/issues/1376">issues</a> work with cabal 3. So if you want to use haskell-ide-engine, you have to use cabal 2.4.1.0 or stack (stack uses cabal 2.4.1.0 internally). We could install cabal and hie using <code>nix-env</code> with commands like:</p>
<pre class="shell"><code>nix-channel --add https://nixos.org/channels/nixos-19.03 nixos-19-03
nix-channel --update
nix-env -iA nixos-19-03.cabal-install
cachix use all-hies
nix-env -iA selection --arg selector 'p: { inherit (p) ghc865; }' -f https://github.com/infinisil/all-hies/tarball/master</code></pre>
<p>But a nicer way to do is to declare these packages in our nix-shell file. It is more flexible, won’t affect our global cabal version, tool like hie requires GHC which you might not want install globally. The nix-shell approach also plays well with lorri.</p>
<p><a href="https://github.com/Infinisil/all-hies">install hie using nix</a></p>
<p>usually we need three nix files for a haskell project.</p>
<ul>
<li>default.nix generated by cabal2nix, which captures our haskell deps <code>cabal2nix . &gt; default.nix</code></li>
</ul>
<h3 id="editor-intergration">Editor intergration</h3>
<p><a href="https://github.com/haskell/haskell-ide-engine/#using-hie-with-spacemacs" class="uri">https://github.com/haskell/haskell-ide-engine/#using-hie-with-spacemacs</a></p>
<h2 id="lorri">Lorri</h2>
<p>Lorri requires direnv. I installed direnv globally using nix.</p>
<p>setup <a href="https://www.tweag.io/posts/2019-03-28-introducing-lorri.html" class="uri">https://www.tweag.io/posts/2019-03-28-introducing-lorri.html</a> <a href="https://github.com/target/lorri/tree/master/example" class="uri">https://github.com/target/lorri/tree/master/example</a> <a href="https://github.com/aveltras/arohi-skeleton" class="uri">https://github.com/aveltras/arohi-skeleton</a></p>
<p>git@github.com:aveltras/arohi-skeleton.git <a href="https://direnv.net/docs/hook.html" class="uri">https://direnv.net/docs/hook.html</a></p>
<p>you can verify cabal version by <code>cabal --version</code></p>
<h2 id="setup-local-dev-tools">Setup local Dev tools</h2>
<p><a href="https://hoogle.haskell.org/">Hoogle</a></p>
<div id="cb6" class="sourceCode">
<div class="sourceCode" id="cb6"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1"></a><span class="kw">{</span> <span class="ex">nixpkgs</span> ? import <span class="op">&lt;</span>nixpkgs<span class="op">&gt;</span> {<span class="kw">}</span> , <span class="ex">compiler</span> ? <span class="st">&quot;ghc865&quot;</span> }:</span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="bu">let</span></span>
<span id="cb6-3"><a href="#cb6-3"></a>  <span class="ex">inherit</span> (nixpkgs) <span class="ex">haskellPackages</span><span class="kw">;</span></span>
<span id="cb6-4"><a href="#cb6-4"></a>  <span class="ex">myPackages</span> = import ./release.nix {inherit nixpkgs compiler<span class="kw">;</span> };</span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="kw">in</span></span>
<span id="cb6-6"><a href="#cb6-6"></a>  <span class="ex">haskellPackages.shellFor</span> {</span>
<span id="cb6-7"><a href="#cb6-7"></a>    <span class="ex">withHoogle</span> = true<span class="kw">;</span></span>
<span id="cb6-8"><a href="#cb6-8"></a>    <span class="ex">packages</span> = p: [myPackages]<span class="kw">;</span></span>
<span id="cb6-9"><a href="#cb6-9"></a>    <span class="ex">buildInputs</span> =  with nixpkgs.haskellPackages<span class="kw">;</span></span>
<span id="cb6-10"><a href="#cb6-10"></a>     [ <span class="ex">hlint</span> stylish-haskell ghcid hoogle]<span class="kw">;</span></span>
<span id="cb6-11"><a href="#cb6-11"></a>}</span></code></pre></div>
</div>
<p>formatter</p>
<p><a href="https://github.com/tweag/ormolu" class="uri">https://github.com/tweag/ormolu</a> hlint stylish-haskell</p>
<p>workflow</p>
<pre class="shell"><code>lorri daemon &amp;
emacs . &amp;
ghcid -c 'cabal new-repl beam-servant-tutorial' -T API.main</code></pre>
<p>cabal new-repl seems only one package to to load</p>
<p>need to figure the limitation of this approach <a href="https://www.parsonsmatt.org/2018/05/19/ghcid_for_the_win.html" class="uri">https://www.parsonsmatt.org/2018/05/19/ghcid_for_the_win.html</a> <a href="https://binarin.ru/post/auto-reload-threepenny-gui/" class="uri">https://binarin.ru/post/auto-reload-threepenny-gui/</a></p>
<p>we still need beam-servant-tutorial.cabal, b/c</p>
<div id="cb8" class="sourceCode">
<div class="sourceCode" id="cb8"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1"></a><span class="ex">unpacking</span> sources</span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="ex">unpacking</span> source archive /nix/store/nf9hhcmb9a0s6qr2y1zd3lj5d36shjyj-beam-servant-tutorial.cabal</span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="kw">do</span> <span class="ex">not</span> know how to unpack source archive /nix/store/nf9hhcmb9a0s6qr2y1zd3lj5d36shjyj-beam-servant-tutorial.cabal</span></code></pre></div>
</div>
<h1 id="aeson-tutorial">Aeson Tutorial</h1>
<p><a href="https://artyom.me/aeson" class="uri">https://artyom.me/aeson</a></p>
<p>customsing field name</p>
<h1 id="servant-tutorial"><a href="https://haskell-servant.readthedocs.io/en/v0.8/tutorial/index.html">Servant Tutorial</a></h1>
<p>Outter level we need (<a href="https://hackage.haskell.org/package/warp">warp</a> package)</p>
<div id="cb9" class="sourceCode">
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1"></a><span class="kw">import</span> <span class="dt">Network.Wai.Handler.Warp</span> (run)</span>
<span id="cb9-2"><a href="#cb9-2"></a></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb9-4"><a href="#cb9-4"></a>main <span class="ot">=</span> run <span class="dv">8081</span> app</span></code></pre></div>
</div>
<p><code>run :: Port -&gt; Application -&gt; IO ()</code></p>
<p><a href="https://www.stackage.org/haddock/nightly-2019-11-17/warp-3.3.4/Network-Wai-Handler-Warp.html#v:run">run</a></p>
<h1 id="beam-tutorial"><a href="https://tathougies.github.io/beam/tutorials/tutorial1/">Beam Tutorial</a></h1>
<h1 id="todo-checkout-input-output-hk-haskell.nix">TODO checkout <a href="https://input-output-hk.github.io/haskell.nix/">input-output-hk haskell.nix</a></h1>
<h1 id="references">References</h1>
<ul>
<li><a href="https://blog.latukha.com/NixOS-HIE-Emacs/" class="uri">https://blog.latukha.com/NixOS-HIE-Emacs/</a></li>
<li><a href="https://www.youtube.com/watch?v=idU7GdlfP9Q" class="uri">https://www.youtube.com/watch?v=idU7GdlfP9Q</a></li>
<li><a href="https://github.com/digital-asset/ghcide/issues/137" class="uri">https://github.com/digital-asset/ghcide/issues/137</a></li>
<li><a href="https://github.com/Gabriel439/haskell-nix" class="uri">https://github.com/Gabriel439/haskell-nix</a></li>
<li><a href="https://cah6.github.io/technology/nix-haskell-1/" class="uri">https://cah6.github.io/technology/nix-haskell-1/</a></li>
<li><a href="https://github.com/cah6/haskell-nix-skeleton-1" class="uri">https://github.com/cah6/haskell-nix-skeleton-1</a></li>
<li><a href="https://nixos.org/nixpkgs/manual/#haskell" class="uri">https://nixos.org/nixpkgs/manual/#haskell</a></li>
</ul>
</section>
</article>
<div id="disqus_thread">

</div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://blog-jsxz1bprob.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>
Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>
</div>
<footer>
Site proudly generated by <a href="http://jaspervdj.be/hakyll">Hakyll</a>
</footer>

        </div>
        <div id="footer">
            Site proudly generated by
            <a href="http://jaspervdj.be/hakyll">Hakyll</a>
        </div>
    </body>
</html>
