---
title: Further nixify this blog build process
date: Feb 02, 2022
modified: Feb 02, 2022
description: Leveraging nix to build this blog end to end
tags: nix 
---

# Goal

Hey, want to share what I learn from leveraging more from nix to build this blog 


# Build steps of this humble blog 

You probably can guess this blog is a plain static site generated by Jekyll or some equivalence programs. Building this site probably just require check in a simple configuration file into github or gitlab, and we are done.

Embrassing yes and no. 

compile Hakyll program, executable the binary to generate a directory, and run tailwind css, and compile a purescript file.

previously, I only out the compile Hakyll program step into my nix file, and github action will run the executable to generate the directory, and deploy it to google storage. All css and js files are check in manully.

I always wanted to move the Hakyll execution, and css and javascript generation step into the nix build step.


# Compile Haskell program

# Generate html

# Tailwind css

# Compile purescript 
Since I have been using spago to build purescript locally, I knew I should use [spago2nix](https://github.com/justinwoo/spago2nix). Follow along the readme, I ran this issue.
```shell
[error] Directory "/" is not accessible. Permissions {readable = True, writable = False, executable = False, searchable = True}
builder for '/nix/store/cv1xmms7j9mgsm08i0ydamjs00ah6yp5-my-frontend-0.1.drv' failed with exit code 1
```

After banging my head to the wall quite time, I was able to find this discourse [post](https://discourse.purescript.org/t/spago2nix-any-complete-example-to-look-at/2532/10) describles the exactly same issue, and someone shared a nix [build](https://github.com/cideM/lions-backend/blob/main/client/default.nix) very close to what I want to do.

Turns out, I need to pass `--global-cache skip` to `spago`

```nix
  frontendJs = pkgs.stdenv.mkDerivation {
          name = "frontendJs";
          buildInputs =
            [ spagoPkgs.installSpagoStyle spagoPkgs.buildSpagoStyle ];
          nativeBuildInputs = with pkgs; [ purs spago ];
          src = ./.;
          unpackPhase = ''
            cp $src/spago.dhall .
            cp $src/packages.dhall .
            cp -r $src/halogen .
            install-spago-style
          '';
          buildPhase = ''
            build-spago-style ./halogen/*.purs
            spago bundle-app --no-install --no-build -m Frontend -t frontend.js --global-cache skip
          '';
          installPhase = ''
            mkdir $out
            mv frontend.js $out/
          '';
        };
```

# Glue everything together

# Local development tool

Two notable downsides:

First, you can imagine, is the dev shell could take a while to load. 
Second, due to how flake pure evaluation works, I need check new posts into git, for my preview command to pick them up.

# Integrate with github action

So I need to change the github action and take my nix output and upload it as artifact. I did run into this [issue](https://github.com/actions/upload-artifact/issues/92). The github upload-artifact action does not work with a symlink to a read-only path. I guess due to some security concerns. Fortunately, I found a nice [workaround](https://github.com/minvws/nl-covid19-notification-app-community-website/commit/cdbd109bf85b041d8cfb6aa0e5304fc926e434b3)

We just need to copy the nix store path to a different place.

```yaml
    - name: "Copy artifacts"
      run: "mkdir build && cp -r result/*  build/"
      run: "mkdir build && cp -r result/*  build/ && chmod +w -R build/"
    - name: "Upload artifact to github"
      uses: actions/upload-artifact@v2
      with:
        name: website
        path: build
```

The overall build step looks like 

```yaml
jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2.4.0
    - uses: cachix/install-nix-action@v16
      with:
        extra_nix_config: |
          access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
    - uses: cachix/cachix-action@v10
      with:
        name: yuanw-blog
        signingKey: ${{ secrets.CACHIX_SIGNING_KEY }}
    - name: Nix build
      run: nix build
    # NOTE Workaround for artifacts and deploy not liking symlinks to
    # read-only paths.
    - name: "Copy artifacts"
      run: "mkdir dist && cp -r result/*  dist/ && chmod +w -R dist/"
    - name: Archive Production Artifact
      uses: actions/upload-artifact@master
      with:
          name: dist
          path: dist
```

Beside setting up nix, the step is pretty nice and clean, if you ask me.

# Conclusion

Beforehand, I knew I might run into some weird issues locally or in github CI. But to my surprise, I was able to quick find the solutions on the web quite fast. I guess this is how internet as its best, and make me want to share this learning experience. 

Thanks for reading, hope this article helps you in some ways.
