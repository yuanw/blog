---
title: Further nixify this blog build process
date: Feb 2, 2022
modified: Feb 2, 2022
description: Leveraging nix to build this blog end to end
tags: nix 
---

# Goal

Hey, want to share what I learn from leveraging more from nix to build this blog 


# Build steps of this humble blog 

You probably can guess this blog is a plain static site generated by Jekyll or some equivalence programs. Building this site probably just require check in a simple configuration file into github or gitlab, and we are done.

Embrassing yes and no. 

compile Hakyll program, executable the binary to generate a directory, and run tailwind css, and compile a purescript file.

previously, I only out the compile Hakyll program step into my nix file, and github action will run the executable to generate the directory, and deploy it to google storage. All css and js files are check in manully.

I always wanted to move the Hakyll execution, and css and javascript generation step into the nix build step.


# Compile Haskell program

# Generate html

# Tailwind css

# Compile purescript 

# Local development tool

One notable downside, you can imagine, is the dev shell could take a while to load. 

# Integrate with github action

So I need to change the github action and take my nix output and upload it as artifact. I did run into this [issue](https://github.com/actions/upload-artifact/issues/92). The github upload-artifact action does not work with a symlink to a read-only path. I guess due to some security concerns. Fortunately, I found a nice [workaround](https://github.com/minvws/nl-covid19-notification-app-community-website/commit/cdbd109bf85b041d8cfb6aa0e5304fc926e434b3)

We just need to copy the nix store path to a different place.

```yaml
    - name: "Copy artifacts"
      run: "mkdir build && cp -r result/*  build/"
      run: "mkdir build && cp -r result/*  build/ && chmod +w -R build/"
    - name: "Upload artifact to github"
      uses: actions/upload-artifact@v2
      with:
        name: website
        path: build
```

The overall build step looks like 

```yaml
jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2.4.0
    - uses: cachix/install-nix-action@v16
      with:
        extra_nix_config: |
          access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
    - uses: cachix/cachix-action@v10
      with:
        name: yuanw-blog
        signingKey: ${{ secrets.CACHIX_SIGNING_KEY }}
    - name: Nix build
      run: nix build
    # NOTE Workaround for artifacts and deploy not liking symlinks to
    # read-only paths.
    - name: "Copy artifacts"
      run: "mkdir dist && cp -r result/*  dist/ && chmod +w -R dist/"
    - name: Archive Production Artifact
      uses: actions/upload-artifact@master
      with:
          name: dist
          path: dist
```

Pretty nice and clean, if you ask me.

# Conclusion

Beforehand, I knew I might run into some weird issues locally or in github CI. But to my surprise, I was able to quick find the solutions on the web quite fast. I guess this is how internet as its best, and make me want to share this learning experience. 

Thanks for reading, hope this article helps you in some ways.  
